-- Register the behaviour
behaviour("PF_AttachmentPoint")

local AttachmentPointBase = {
	EquipAttachment = function (self, attachmentIndex)
		local attachmentType = {
			["sights"] = function (self, attachment, animatorOnly) -- Sights shiets
				local weapon = Player.actor.activeWeapon
				local attachmentData = attachment.gameObject.GetComponent(DataContainer)

				weapon.aimFov = attachmentData.GetFloat("aimFov")
			end,
		
			["muzzles"] = function (self, attachment, animatorOnly) -- isLoud and muzzle flash visibilty
			end,
		
			["toggleableRail"] = function(self, attachment, animatorOnly) -- Toggleable Rail, when pressing x it either enables or disables the rail power
			end,
		
			["stock"] = function (self, attachment, animatorOnly) -- Changes recoil and aimin speed
				local weapon = Player.actor.activeWeapon
				local attachmentData = attachment.gameObject.GetComponent(DataContainer)

				weapon.recoilBaseKickback = attachmentData.GetFloat("kickback")
				weapon.recoilKickbackProneMultiplier = attachmentData.GetFloat("kickbackProneMultiplier")
				weapon.recoilRandomKickback = attachmentData.GetFloat("randomKick")
				weapon.recoilSnapDuration = attachmentData.GetFloat("snapDuration")
				weapon.recoilSnapFrequency = attachmentData.GetFloat("snapFrequency")
				weapon.recoilSnapMagnitude = attachmentData.GetFloat("snapMagnitude")
				weapon.recoilSnapProneMultiplier = attachmentData.GetFloat("snapProneMultiplier")
		
			end,
		
			["underbarrel"] = function (self, attachment, animatorOnly) -- Controls followup spread
			end,
		
			["mag"] = function (self, attachment, animatorOnly) -- Changes player movement speed and ammo count
			end,
		
			["skin"] = function (self, attachment, animatorOnly) -- Changes weapon material... Will finish later
				local attachmentPoint = self.weaponPoint.gameObject.GetComponent(DataContainer)
				local attachmentData = attachment.gameObject.GetComponent(DataContainer)
		
				local rendererArray = attachmentPoint.GetGameObjectArray("mesh")
				local materialIndexArray = attachmentPoint.GetIntArray("meshMaterialIndex")
		
				local matArray = {}

				for i = 1, #rendererArray do
					local matIndex = materialIndexArray[i]
					local rendererComp = rendererArray[i].gameObject.GetComponent(Renderer)
		
					for i = 1, #rendererComp.materials + 1 do
						matArray[i] = attachmentPoint.GetMaterial("defaultMat")
					end
					matArray[matIndex] = attachmentData.GetMaterial("skin")
				end
			end,
		
			["receiver"] = function (self, attachment, animatorOnly) -- Does nothing?
			end,
		
			["nil"] = function (self, attachment, animatorOnly) -- Does nothing lol, stupid ass modder cant even set up an attachment correctly
			end
		}
		
		-- Start Equip Attachment
		local data = self.weaponPoint.gameObject.GetComponent(DataContainer)
		local attachments = PhoenixData.GetGameObject(data, "attachment", true, nil)
		
		-- Checks if the attachmentIndex is higher then the currnet ammount of attachments and if so sets attachmentIndex to 1
		if attachmentIndex > #attachments then
			attachmentIndex = 1
		end

		-- Visual stuff
		-- Disables old attachment
		attachments[_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][self.pointIndex]].gameObject.SetActive(false)
		
		-- Enables new attachment
		attachments[attachmentIndex].gameObject.SetActive(true)

		-- Applys stats and stuff
		attachmentType[PhoenixData.GetString(data, "attachmentType", false, "nil")](self, attachments[attachmentIndex])
		_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][self.pointIndex] = attachmentIndex
	end,

	OnWeaponChange = function (self)
		local bindTable = {
			["1"] = KeyCode.Alpha1,
			["2"] = KeyCode.Alpha2,
			["3"] = KeyCode.Alpha3,
			["4"] = KeyCode.Alpha4,
			["5"] = KeyCode.Alpha5,
			["6"] = KeyCode.Alpha6,
			["7"] = KeyCode.Alpha7,
			["8"] = KeyCode.Alpha8,
			["9"] = KeyCode.Alpha9,
			["0"] = KeyCode.Alpha0,
		}

		local flipped = PhoenixData.GetBool(self.weaponPoint.gameObject.GetComponent(DataContainer), "flipped", false, false)
		local pointData = self.weaponPoint.gameObject.GetComponent(DataContainer)

		if flipped then 
			PhoenixData.GetGameObject(self.targets.right.gameObject.GetComponent(DataContainer), "pointName", false, nil).gameObject.GetComponent(TextMeshProUGUI).text = "[".. tostring(PhoenixData.GetInt(pointData, "bind", false, 1)) .."] " .. PhoenixData.GetString(pointData, "pointName", false, "Yooo Setup ya gun")
			self.targets.left.gameObject.SetActive(false)
			self.targets.right.gameObject.SetActive(true)
		else
			PhoenixData.GetGameObject(self.targets.left.gameObject.GetComponent(DataContainer), "pointName", false, nil).gameObject.GetComponent(TextMeshProUGUI).text = PhoenixData.GetString(pointData, "pointName", false, "Yooo Setup ya gun") .. " [".. tostring(PhoenixData.GetInt(pointData, "bind", false, 1)) .."]"
			self.targets.left.gameObject.SetActive(true)
			self.targets.right.gameObject.SetActive(false)
		end

		self.bind = bindTable[tostring(PhoenixData.GetInt(pointData, "bind", false, 1))]

		-- Storage Stuff
		print(tostring(_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][self.pointIndex])) 
	end,

	OnClick = function (self)
		m_PhoenixAttachment.sfxSource.PlayOneShot(self.targets.sfx, 7)
	end,
}

function PF_AttachmentPoint:OnWeaponChange() AttachmentPointBase.OnWeaponChange(self) end
function PF_AttachmentPoint:OnClick() AttachmentPointBase.OnClick(self) end
function PF_AttachmentPoint:EquipAttachment(index) AttachmentPointBase.EquipAttachment(self, index) end

function PF_AttachmentPoint:Initialise()
	self.targets.left.gameObject.GetComponent(Button).onClick.AddListener(self, "OnClick")
	self.targets.right.gameObject.GetComponent(Button).onClick.AddListener(self, "OnClick")
end

function PF_AttachmentPoint:Update()
	if self.weaponPoint == nil or not m_PhoenixAttachment.menuState then return end

	self.gameObject.transform.position = PlayerCamera.activeCamera.WorldToScreenPoint(self.weaponPoint.gameObject.transform.position)

	if Input.GetKeyDown(self.bind) then
		self:EquipAttachment(_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][self.pointIndex] + 1)
	end
end