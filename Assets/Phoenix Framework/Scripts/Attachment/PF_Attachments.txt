-- Register the behaviour
behaviour("PF_Attachments")

-- Local Tables
local attachmentPointsTable = {}

local AttachmentUI = {
	RefreshMenuText = function (self)
		if self.weaponChanged == false then return end

		local data = Player.actor.activeWeapon.gameObject.GetComponent(DataContainer)
		local weaponName = PhoenixData.GetString(data, "weaponName", false, "Cool Gun")

		if string.len(weaponName) >= 8 then
			self.weaponNameText.text = "<smallcaps>" .. weaponName .. "</smallcaps> <color=#808080ff><size=20>By: " .. PhoenixData.GetString(data, "creatorName", false, "Swag dude's gun")
		else
			self.weaponNameText.text = '<align="left"><smallcaps>' .. weaponName .. '</smallcaps>' .. '\n <align="right"><color=#808080ff><size=20>By: ' .. PhoenixData.GetString(data, "creatorName", false, "Swag dude's gun")
		end

		-- self.weaponNameText.text = "<smallcaps>" .. PhoenixData.GetString(data, "weaponName", false, "Cool Gun") .. "</smallcaps> <color=#808080ff><size=20>By: " .. PhoenixData.GetString(data, "creatorName", false, "Swag dude's gun")
		self.historyHeaderText.text = PhoenixData.GetString(data, "weaponHistoryTitle", false, "Cool Gun's History")
		self.historyDescText.text = PhoenixData.GetString(data, "weaponHistory", false, "This is a very cool gun")
		self.statsHeaderText.text = weaponName .. " Stats"

		-- Menu UI stuffs... this is so painful....
		-- Recoil Stats
		local recoilRange = PhoenixData.GetVector(data, "recoilRange", false, Vector3(0,1,0))
		self.statsRecoilSlider.minValue = recoilRange.x 
		self.statsRecoilSlider.maxValue = recoilRange.y
		self.statsRecoilLeft.text = tostring(Mathf.Floor(recoilRange.x * 10) / 10)
		self.statsRecoilRight.text = tostring(Mathf.Floor(recoilRange.y * 10) / 10)

		-- Spread
		local spreadRange = PhoenixData.GetVector(data, "spreadRange", false, Vector3(0,1,0))
		self.statsSpreadSlider.minValue = spreadRange.x
		self.statsSpreadSlider.maxValue = spreadRange.y
		self.statsSpreadLeft.text = tostring(Mathf.Floor(spreadRange.x * 10) / 10)
		self.statsSpreadRight.text = tostring(Mathf.Floor(spreadRange.y * 10) / 10)

		-- Move Speed
		local moveSpeedRange = PhoenixData.GetVector(data, "moveSpeedRange", false, Vector3(0,1,0))
		self.statsMoveSpeedSlider.minValue = moveSpeedRange.x
		self.statsMoveSpeedSlider.maxValue = moveSpeedRange.y
		self.statsMoveSpeedLeft.text = tostring(Mathf.Floor(moveSpeedRange.x * 10) / 10)
		self.statsMoveSpeedRight.text = tostring(Mathf.Floor(moveSpeedRange.y * 10) / 10)

		-- Fire Rate
		local fireRateRange = PhoenixData.GetVector(data, "fireRateRange", false, Vector3(0,1,0))
		self.statsFireRateSlider.minValue = fireRateRange.x
		self.statsFireRateSlider.maxValue = fireRateRange.y
		self.statsFireRateLeft.text = tostring(Mathf.Floor(fireRateRange.x * 10) / 10)
		self.statsFireRateRight.text = tostring(Mathf.Floor(fireRateRange.y * 10) / 10)

		local damageRange = PhoenixData.GetVector(data, "damageRange", false, Vector3(0,1,0))
		self.statsDamgeSlider.minValue = damageRange.x
		self.statsDamgeSlider.maxValue = damageRange.y
		self.statsDamgeLeft.text = tostring(Mathf.Floor(damageRange.x * 10) / 10)
		self.statsDamgeRight.text = tostring(Mathf.Floor(damageRange.y * 10) / 10)

		-- SFX source
		self.sfxSource = self.targets.sfxSource.gameObject.GetComponent(AudioSource)

		self.weaponChanged = false
	end,
}

local AttachmentBase = {
	SetupKeybinds = function (self)
		self.attachmentKeybind = PhoenixInput.AttachmentMenuKeybind()
	end,

	CloneAttachmentPanel = function (self)

	end,

	SetupEvents = function (self)
		self.script.AddValueMonitor("ReturnIsPaused", "OnGamePaused")
	end,

	StoreComponents = function (self)
		-- variables I have to declare
		self.transitionMultiplier = 1
		self.slowMotionMultiplier = 1

		-- Base header and canvas animator
		self.menuUI = self.targets.MenuUI.gameObject.GetComponent(Animator)
		self.weaponNameText = self.targets.weaponNameText.gameObject.GetComponent(TextMeshProUGUI)
		self.historyHeaderText = self.targets.historyHeaderText.gameObject.GetComponent(TextMeshProUGUI)
		self.historyDescText = self.targets.historyDescText.gameObject.GetComponent(TextMeshProUGUI)
		self.statsHeaderText = self.targets.statsHeaderText.gameObject.GetComponent(TextMeshProUGUI)

		-- Stats Panel
		self.statsRecoil = self.targets.statsRecoil.gameObject.GetComponent(DataContainer)
		self.statsSpread = self.targets.statsSpread.gameObject.GetComponent(DataContainer)
		self.statsMoveSpeed = self.targets.statsMoveSpeed.gameObject.GetComponent(DataContainer)
		self.statsFireRate = self.targets.statsFireRate.gameObject.GetComponent(DataContainer)
		self.statsDamge = self.targets.statsDamge.gameObject.GetComponent(DataContainer)

		-- FUCK I HATE THIS, its for the stats panel
		-- Recoil
		self.statsRecoilSlider = self.statsRecoil.GetGameObject("slider").GetComponent(Slider)
		self.statsRecoilLeft = self.statsRecoil.GetGameObject("left").GetComponent(TextMeshProUGUI)
		self.statsRecoilRight = self.statsRecoil.GetGameObject("right").GetComponent(TextMeshProUGUI)

		-- Spread
		self.statsSpreadSlider = self.statsSpread.GetGameObject("slider").GetComponent(Slider)
		self.statsSpreadLeft = self.statsSpread.GetGameObject("left").GetComponent(TextMeshProUGUI)
		self.statsSpreadRight = self.statsSpread.GetGameObject("right").GetComponent(TextMeshProUGUI)

		-- Movement Speed
		self.statsMoveSpeedSlider = self.statsMoveSpeed.GetGameObject("slider").GetComponent(Slider)
		self.statsMoveSpeedLeft = self.statsMoveSpeed.GetGameObject("left").GetComponent(TextMeshProUGUI)
		self.statsMoveSpeedRight = self.statsMoveSpeed.GetGameObject("right").GetComponent(TextMeshProUGUI)

		-- Fire Rate
		self.statsFireRateSlider = self.statsFireRate.GetGameObject("slider").GetComponent(Slider)
		self.statsFireRateLeft = self.statsFireRate.GetGameObject("left").GetComponent(TextMeshProUGUI)
		self.statsFireRateRight = self.statsFireRate.GetGameObject("right").GetComponent(TextMeshProUGUI)

		-- Damge
		self.statsDamgeSlider = self.statsDamge.GetGameObject("slider").GetComponent(Slider)
		self.statsDamgeLeft = self.statsDamge.GetGameObject("left").GetComponent(TextMeshProUGUI)
		self.statsDamgeRight = self.statsDamge.GetGameObject("right").GetComponent(TextMeshProUGUI)

		-- Attachment point stuff
		self.attachmentPointNest = self.targets.attachmentPointNest.gameObject.transform
		self.attachmentPointInstance = self.targets.attachmentPointInstance

		-- Spawns the attachment points, and willspawn more if gun has more then currently spawned.. not here doe
		for i = 1, 10 do
			go = GameObject.Instantiate(self.attachmentPointInstance)
			go.transform.SetParent(self.attachmentPointNest, false)
			attachmentPointsTable[i] = go
			self.script.GetScript(go):Initialise()
		end
	end,

	PlayerStatusCheck = function (self)
		return Player.actor.activeWeapon.isReloading == false 
		and Player.actor.activeWeapon.isUnholstered == true 
		and Player.actor.isInWater == false 
		and Player.actor.isOnLadder == false 
		and GameManager.isPaused == false
	end,

	ToggleMenu = function (self, state)
		local MenuState = {
			["true"] = function (self)
				AttachmentUI.RefreshMenuText(self)
				-- State
				self.menuState = true
				self.menuStateNumber = 1
				self.transitionMultiplier = 1
				
				-- Weapon Animations
				Player.actor.activeWeapon.animator.SetBool("customization", true)
				-- Player.actor.activeWeapon.gameObject.GetComponent(Animator).updateMode = AnimatorUpdateMode.UnscaledTime
				Player.actor.activeWeapon.LockWeapon()

				-- Changes time
				-- Time.timeScale = 0.03125
				Screen.UnlockCursor()

				-- Stupid gamehud stuff
				GameManager.hudGameModeEnabled = false
				GameManager.hudPlayerEnabled = false
			end,

			["false"] = function (self)
				self.menuState = false
				self.menuStateNumber = 0
				self.transitionMultiplier = 9.5

				-- Weapon Animations
				Player.actor.activeWeapon.animator.SetBool("customization", false)
				Player.actor.activeWeapon.gameObject.GetComponent(Animator).updateMode = AnimatorUpdateMode.Normal
				Player.actor.activeWeapon.UnlockWeapon()

				-- Changes time
				-- Time.timeScale = 1
				Screen.LockCursor()

				-- Stupid gamehud stuff
				if Player.actor == nil or Player.actor.isDead then return end
				GameManager.hudGameModeEnabled = true
				GameManager.hudPlayerEnabled = true
			end,
		}

		MenuState[tostring(state)](self)
	end,

	RefreshPoints = function (self, type)
		local typeSwitch = {
			["OnEnable"] = function (self)
				local data = Player.actor.activeWeapon.gameObject.GetComponentsInChildren(DataContainer)
				local dataIndex = 0
		
				for k,v in ipairs(data) do
					if PhoenixData.GetString(v, "dataType", false, "nahDontGotIt") == "attachmentPoint" then 
						if dataIndex == self.attachmentPointNest.childCount then return end
		
						-- Gets the UI (Framework) element for the point 
						local go = self.attachmentPointNest.GetChild(dataIndex).gameObject
						go.SetActive(true)

						-- Storage Stuff
						if _G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][dataIndex + 1] == nil then
							_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)][dataIndex + 1] = {}
							print("Creating Table")
						end

						-- Does point stuff
						local pointScript = self.script.GetScript(go.gameObject)
						pointScript.attachmentBase = self
						pointScript.weaponPoint = v.gameObject
						pointScript.pointIndex = dataIndex + 1
						pointScript:OnWeaponChange()

						-- pluses the index
						dataIndex = 1 + dataIndex
					end
				end
			end,

			["OnDisable"] = function (self)
				for i = 1, self.attachmentPointNest.childCount do
					self.attachmentPointNest.GetChild(i - 1).gameObject.SetActive(false)
				end
			end,
		}

		typeSwitch[tostring(type)](self)
	end,
}

local AttachmentEvents = {
	OnPause = function (self, bool)
		local state = {
		["true"] = function (self) 
			AttachmentBase.ToggleMenu(self, false)
			self.menuUI.gameObject.SetActive(false)
			self.menuUI.gameObject.SetActive(true)
		end, 
		["false"] = function () end,
		}
	state[tostring(bool)](self)
	end,
}
function PF_Attachments:Initialise()
	m_PhoenixAttachment= self

	AttachmentBase.SetupKeybinds(self)
	AttachmentBase.StoreComponents(self)
	AttachmentBase.SetupEvents(self)
	AttachmentBase.RefreshPoints(self, "OnDisable")

	PhoenixDebug.Print("PF_Attachments | Initialise", "log")
end

function PF_Attachments:Update()
	if Input.GetKeyBindButtonDown(KeyBinds.Slowmotion) and self.menuUI.GetFloat("State") ~= 1 then
		local SlowmoState = {
			["true"] = 0.2,
			["false"] = 1
		}

		self.isSlowMode = not self.isSlowMode
		self.slowMotionMultiplier = SlowmoState[tostring(self.isSlowMode)]
	end

	if not Player.actor.isDead and not GameManager.isPaused then
		self.menuUI.SetFloat("State", self.menuStateNumber, 0.2 / self.transitionMultiplier, Time.unscaledDeltaTime)
		Time.timeScale = PhoenixMath.Normalize(self.menuUI.GetFloat("State"), 1 , 0, 0.0325, 1 * self.slowMotionMultiplier)
	end
	
	if Input.GetKeyDown(self.attachmentKeybind) and AttachmentBase.PlayerStatusCheck() then
		AttachmentBase.ToggleMenu(self, not self.menuState)
	end

	if Input.GetKeyDown(KeyCode.Return) then 
		AttachmentBase.ToggleMenu(self, false)
	end
end

function PF_Attachments:OnDisable()
	if Player.actor == nil or Player.actor.isDead then return end
	AttachmentBase.ToggleMenu(self, false)
	AttachmentBase.RefreshPoints(self, "OnDisable")
	-- Slowmode stuff
	local SlowmoState = {
		["true"] = 0.2,
		["false"] = 1
	}
	Time.timeScale = SlowmoState[tostring(self.isSlowMode)]
end

function PF_Attachments:OnEnable()
	if Player.actor == nil or Player.actor.isDead  then return end

	-- Sets up storage stuff on weapon switch
	if _G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)] == nil then
		_G.PhoenixGlobalStorage["SavedAttachments"][tostring(Player.actor.activeWeapon)] = {}
	end

	Player.actor.activeWeapon.animator.SetBool("customization", false)
	Player.actor.activeWeapon.gameObject.GetComponent(Animator).updateMode = AnimatorUpdateMode.Normal

	self.weaponChanged = true

	AttachmentBase.ToggleMenu(self, false)
	AttachmentBase.RefreshPoints(self, "OnEnable")


	-- Slowmode stuff
	if Time.timeScale <= 0.3 then self.isSlowMode = true else self.isSlowMode = false end

	local SlowmoState = {
		["true"] = 0.2,
		["false"] = 1
	}
	self.slowMotionMultiplier = SlowmoState[tostring(self.isSlowMode)]
end

function PF_Attachments:ReturnIsPaused() return GameManager.isPaused end

function PF_Attachments:OnGamePaused(bool) AttachmentEvents.OnPause(self, bool) end